#!/bin/bash
# run_onchange_system-setup.sh.tmpl
# System setup including packages, shell configuration, and fonts
# IMPORTANT: this script needs to be idempotent

set -e

echo "Running system setup..."
echo

# ==============================================================================
# Package Lists
# ==============================================================================

# Core utilities and tools
PACKAGES=(
    # Terminal emulator
    ghostty

    # Shell
    fish

    # Git extensions
    git-lfs
)

# ==============================================================================
# Installation
# ==============================================================================

install_packages() {
    echo "ðŸ“¦ Installing packages..."

    local packages_to_install=()

    # Check which packages are not installed
    for package in "${PACKAGES[@]}"; do
        if ! pacman -Q "$package" &> /dev/null; then
            packages_to_install+=("$package")
        fi
    done

    # Install missing packages
    if [ ${#packages_to_install[@]} -gt 0 ]; then
        echo "	Installing packages: ${packages_to_install[*]}"
        sudo pacman -S --noconfirm --needed "${packages_to_install[@]}"
        echo "	âœ“ Packages installed successfully"
    else
        echo "	âœ“ All packages are already installed"
    fi
}

install_fisher() {
    echo "ðŸ¡ Setting up Fisher and fish plugins..."

    # Check if fish is installed
    if ! command -v fish &> /dev/null; then
        echo "	âš ï¸  Fish shell is not installed. Skipping Fisher setup."
        return 0
    fi

    # Check if Fisher is already installed
    if fish -c "type -q fisher" &> /dev/null; then
        echo "	âœ“ Fisher already installed"
    else
        echo "	â¬‡ï¸  Installing Fisher..."
        fish -c "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher" &> /dev/null
        echo "	âœ“ Fisher installed successfully"
    fi

    # Install/update plugins from fish_plugins file
    if [ -f ~/.config/fish/fish_plugins ]; then
        echo "	ðŸ“¦ Syncing fish plugins..."
        fish -c "fisher update" &> /dev/null
        echo "	âœ“ Fish plugins synced successfully"
    fi
}

install_tx02_font() {
    echo "ðŸ”¤ Installing TX-02 font..."

    # Check if TX-02 font is already installed
    if [[ -f ~/.local/share/fonts/TX-02-Variable.ttf ]]; then
        echo "	âœ“ TX-02 font already installed"

        # Set TX-02 as the system font using omarchy if not already set
        if command -v omarchy-font-set &> /dev/null && command -v omarchy-font-current &> /dev/null; then
            current_font=$(omarchy-font-current)
            if [[ "$current_font" != "TX-02-Variable" ]]; then
                echo "	ðŸŽ¨ Setting TX-02 as system font..."
                if omarchy-font-set "TX-02-Variable" &> /dev/null; then
                    echo "	âœ“ TX-02 set as system font"
                else
                    echo "	âš ï¸  Warning: Failed to set TX-02 as system font"
                fi
            fi
        fi

        return 0
    fi

    # Check if 1Password CLI is installed
    if ! command -v op &> /dev/null; then
        echo "	âš ï¸  1Password CLI not installed"
        echo "	   Install with: pacman -S 1password-cli"
        echo "	   Skipping font installation"
        return 0
    fi

    # Check if logged in to 1Password
    if ! op account list &> /dev/null; then
        echo "	âš ï¸  Not logged in to 1Password"
        echo "	   Login with: eval \$(op signin)"
        echo "	   Skipping font installation"
        return 0
    fi

    # Ensure fonts directory exists
    mkdir -p ~/.local/share/fonts

    # Download TX-02 font from 1Password
    echo "	â¬‡ï¸  Downloading TX-02-Variable from 1Password..."
    if op document get "TX-02-Variable" --force -o ~/.local/share/fonts/TX-02-Variable.ttf &> /dev/null; then
        echo "	âœ“ Font downloaded successfully"

        # Rebuild font cache (suppress all output)
        fc-cache -f &> /dev/null
        echo "	âœ“ Font cache updated"

        # Set TX-02 as the system font using omarchy
        if command -v omarchy-font-set &> /dev/null; then
            echo "	ðŸŽ¨ Setting TX-02 as system font..."
            if omarchy-font-set "TX-02-Variable" &> /dev/null; then
                echo "	âœ“ TX-02 set as system font"
            else
                echo "	âš ï¸  Warning: Failed to set TX-02 as system font"
            fi
        fi
    else
        echo "	âœ— Failed to download TX-02 font"
        echo "	   Check that 'TX-02-Variable' document exists in your 1Password vault"
        return 1
    fi
}

change_shell_to_fish() {
    echo "ðŸ  Configuring fish as default shell..."

    # Check if fish is installed
    if ! command -v fish &> /dev/null; then
        echo "	âš ï¸  Fish shell is not installed. Skipping shell change."
        return 0
    fi

    FISH_PATH=$(which fish)
    CURRENT_SHELL=$(getent passwd "$USER" | cut -d: -f7)

    # Check if shell is already fish
    if [ "$CURRENT_SHELL" = "$FISH_PATH" ]; then
        echo "	âœ“ Default shell is already set to fish"
        return 0
    fi

    # Check if fish is in /etc/shells
    if ! grep -q "^$FISH_PATH$" /etc/shells; then
        echo "	ðŸ“ Adding $FISH_PATH to /etc/shells..."
        echo "$FISH_PATH" | sudo tee -a /etc/shells > /dev/null
    fi

    # Change the shell
    echo "	ðŸ”„ Changing shell from $CURRENT_SHELL to $FISH_PATH..."
    chsh -s "$FISH_PATH"
    echo "	âœ“ Default shell changed to fish"
    echo "	   Please log out and log back in for the change to take effect"
}

# ==============================================================================
# Main execution
# ==============================================================================

install_packages
echo
install_fisher
echo
install_tx02_font
echo
change_shell_to_fish

echo
echo "âœ… System setup complete!"
